<div class="container-fluid px-2 mt-3">
  <div class="header-section mb-3">
    <h5 class="text-primary fw-bold mb-1">üçû DEVOLUCIONES PAN</h5>
    <small class="text-muted">Fecha: {{ fechaActual | date : 'dd/MM/yyyy' }}</small>
  </div>

  <!-- Bot√≥n para agregar producto -->
  <div class="agregar-producto-section mb-3">
    <button 
      class="btn btn-outline-primary btn-sm"
      (click)="mostrarFormulario = !mostrarFormulario">
      {{ mostrarFormulario ? '‚ùå Cancelar' : '‚ûï Agregar Producto' }}
    </button>
    <div class="export-section text-center mt-4">
      <button type="button" class="btn btn-danger" (click)="limpiarFormulario()">
        Limpiar Formulario
      </button>
    </div>
    
    <!-- Formulario para nuevo producto -->
    <div class="nuevo-producto-form mt-3" *ngIf="mostrarFormulario">
      <form [formGroup]="nuevoProductoForm" (ngSubmit)="agregarProducto()">
        <div class="row g-2">
          <div class="col-4">
            <input 
              type="text" 
              class="form-control form-control-sm"
              formControlName="codigo"
              placeholder="C√≥digo"
              maxlength="10">
          </div>
          <div class="col-6">
            <input 
              type="text" 
              class="form-control form-control-sm"
              formControlName="descripcion"
              placeholder="Descripci√≥n"
              maxlength="50">
          </div>
          <div class="col-2">
            <button 
              type="submit" 
              class="btn btn-success btn-sm w-100"
              [disabled]="nuevoProductoForm.invalid">
              ‚úì
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <form [formGroup]="formulario">
    <div class="productos-section">
      <div *ngFor="let producto of productos; let i = index" 
           class="producto-row"
           [class.bandejas-especiales]="producto.codigo === ''"
           [class.producto-personalizado]="esProductoPersonalizado(i)">
        
        <!-- √çNDICE VISUAL -->
        <div class="indice-visual" 
             [class.indice-bandejas]="producto.codigo === ''"
             [class.indice-personalizado]="esProductoPersonalizado(i)">
          {{ i + 1 }}
        </div>
        
        <div class="producto-info">
          <div class="codigo-section">
            <span class="label-small">C√ìDIGO</span>
            <div class="codigo-value" [class.codigo-empty]="producto.codigo === ''">
              {{ producto.codigo || '---' }}
            </div>
          </div>
          
          <div class="descripcion-section">
            <span class="label-small">DESCRIPCI√ìN</span>
            <div class="descripcion-value" [class.descripcion-bandejas]="producto.codigo === ''">
              {{ producto.descripcion }}
            </div>
          </div>

          <!-- Bot√≥n eliminar para productos personalizados -->
          <div class="acciones-section" *ngIf="esProductoPersonalizado(i)">
            <button 
              type="button"
              class="btn btn-outline-danger btn-sm"
              (click)="eliminarProductoPersonalizado(i)"
              title="Eliminar producto">
              üóëÔ∏è
            </button>
          </div>
        </div>
        
        <div class="cantidad-section">
          <span class="label-small">CANTIDAD</span>
          <input
            type="tel"
            min="0"
            class="form-control input-cantidad"
            [class.input-bandejas]="producto.codigo === ''"
            [formControl]="$any(formulario.get('unidades')).at(i)"
            placeholder="0"
            (focus)="onFocus($event, i)"
            (input)="onInput($event, i)"
          />
        </div>
      </div>
    </div>
    
    <div class="export-section text-center mt-4 mb-4">
      <button type="button" class="btn btn-success btn-export" (click)="exportarExcel()">
        üìä Exportar a Excel
      </button>
    </div>
  </form>
</div>
