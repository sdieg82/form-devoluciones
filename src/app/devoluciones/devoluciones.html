<div class="container-fluid px-2 mt-3">
  <div class="header-section mb-3">
    <h5 class="text-primary fw-bold mb-1">üçû DEVOLUCIONES PAN</h5>
    <small class="text-muted">Fecha: {{ fechaActual | date : 'dd/MM/yyyy' }}</small>
  </div>

  <!-- Bot√≥n para agregar producto -->
  <div class="agregar-producto-section mb-3">
    <button 
      class="btn btn-outline-primary btn-sm"
      (click)="mostrarFormulario = !mostrarFormulario">
      {{ mostrarFormulario ? '‚ùå Cancelar' : '‚ûï Agregar Producto' }}
    </button>
    <div class="export-section text-center mt-4">
      <button type="button" class="btn btn-danger" (click)="limpiarFormulario()">
        Limpiar Formulario
      </button>
    </div>

    <div class="search-bar mt-3 mb-3">
      <input 
      type="text" 
      placeholder="Buscar por producto o c√≥digo..." 
      class="form-control form-control-sm" 
      [(ngModel)]="searchTerm" 
      >
    </div>
    
    <!-- Formulario para nuevo producto -->
    <div class="nuevo-producto-form mt-3" *ngIf="mostrarFormulario">
      <form [formGroup]="nuevoProductoForm" (ngSubmit)="agregarProducto()">
        <div class="row g-2">
          <div class="col-4">
            <input 
              type="text" 
              class="form-control form-control-sm"
              formControlName="codigo"
              placeholder="C√≥digo"
              maxlength="10">
          </div>
          <div class="col-6">
            <input 
              type="text" 
              class="form-control form-control-sm"
              formControlName="descripcion"
              placeholder="Descripci√≥n"
              maxlength="50">
          </div>
          <div class="col-2">
            <button 
              type="submit" 
              class="btn btn-success btn-sm w-100"
              [disabled]="nuevoProductoForm.invalid">
              ‚úì
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <form [formGroup]="formulario">
    <div class="productos-section">
      <div *ngFor="let producto of productosFiltrados; let i = index" 
     class="producto-row"
     [class.bandejas-especiales]="producto.codigo === '000000'"
     [class.producto-personalizado]="esProductoPersonalizado(obtenerIndiceReal(producto))">
  
  <!-- √çNDICE VISUAL -->
  <div class="indice-visual" 
       [class.indice-bandejas]="producto.codigo === '000000'"
       [class.indice-personalizado]="esProductoPersonalizado(obtenerIndiceReal(producto))">
    {{ obtenerIndiceReal(producto) + 1 }}
  </div>
  
  <div class="producto-info">
    <div class="codigo-section">
      <span class="label-small">C√ìDIGO</span>
      <div class="codigo-value" [class.codigo-empty]="producto.codigo === '000000'">
        {{ producto.codigo === '000000' ? '---' : producto.codigo }}
      </div>
    </div>
    
    <div class="descripcion-section">
      <span class="label-small">DESCRIPCI√ìN</span>
      <div class="descripcion-value" [class.descripcion-bandejas]="producto.codigo === '000000'">
        {{ producto.descripcion }}
      </div>
    </div>

    <div class="acciones-section" *ngIf="esProductoPersonalizado(obtenerIndiceReal(producto))">
      <button 
        type="button"
        class="btn btn-outline-danger btn-sm"
        (click)="eliminarProductoPersonalizado(obtenerIndiceReal(producto))"
        title="Eliminar producto">
        üóëÔ∏è
      </button>
    </div>
  </div>
  
  <div class="cantidad-section">
    <span class="label-small">CANTIDAD</span>
    <input
      type="tel"
      min="0"
      class="form-control input-cantidad"
      [class.input-bandejas]="producto.codigo === '000000'"
      [formControl]="$any(formulario.get('unidades')).at(obtenerIndiceReal(producto))"
      placeholder="0"
      (focus)="onFocus($event, obtenerIndiceReal(producto))"
      (input)="onInput($event, obtenerIndiceReal(producto))"
    />
  </div>
</div>

    </div>
    
    <div class="export-section text-center mt-4 mb-4">
      <button type="button" class="btn btn-success btn-export" (click)="exportarExcel()">
        üìä Exportar a Excel
      </button>
    </div>
  </form>
</div>
