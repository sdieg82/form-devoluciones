<app-nav-bar></app-nav-bar>

<!-- Bot√≥n para abrir modal -->
<div style="display: flex; justify-content: center" class="mt-3 mb-3">
  <button type="button" class="btn btn-success" (click)="abrirModal()">
    ‚ûï Agregar Registro de Promoci√≥n
  </button>
</div>

<!-- Tabla de registros de promociones -->
<div class="registros-section mb-4">
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead class="table-dark">
            <tr>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Factura</th>
              <th>Producto</th>
              <th>U. Vendidas</th>
              <th>U. Promociones</th>
              <th>Costo Promocional</th>
              <th>Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let registro of registrosVentas; let i = index">
              <td>{{ registro.fecha | date : 'dd/MM/yyyy' }}</td>
              <td>{{ registro.cliente }}</td>
              <td>{{ registro.factura }}</td>
              <td>{{ registro.producto }}</td>
              <td class="text-center">{{ registro.unidadesVendidas }}</td>
              <td class="text-center">{{ registro.unidadesPromociones }}</td>
              <td>$ {{ registro.valor }}</td>
              <td>
                <strong>{{ registro.unidadesPromociones * registro.valor }}</strong>
              </td>
              <td>
                <button
                  type="button"
                  class="btn btn-outline-danger btn-sm"
                  (click)="eliminarRegistro(i)"
                  title="Eliminar registro"
                >
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          </tbody>
          <tfoot class="table-info">
            <tr>
              <td colspan="7" class="text-end"><strong>TOTAL GENERAL:</strong></td>
              <td colspan="2">
                <strong class="text-success">{{ getTotalRegistros() }}</strong>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Botones de acci√≥n -->
<div style="display: flex; justify-content: center">
  <button type="button" class="btn btn-success me-2" (click)="exportarExcel()">
    üìä Exportar a Excel
  </button>
</div>

<div class="export-section text-center mt-2">
  <button type="button" class="btn btn-danger" (click)="limpiarFormulario()">
    Limpiar Registros
  </button>
</div>

<!-- MODAL para el formulario -->
<div
  class="modal fade"
  id="promocionModal"
  tabindex="-1"
  aria-labelledby="promocionModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="promocionModalLabel">üìù Nuevo Registro de Promoci√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form [formGroup]="nuevoProductoForm" (ngSubmit)="agregarProducto()">
        <div class="modal-body">
          <!-- Primera fila: Fecha y Cliente -->
          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label text-muted small">üìÖ FECHA</label>
              <input
                type="date"
                class="form-control form-control-sm"
                formControlName="fecha"
                (change)="onDateChange($event)"
              />
              <div
                *ngIf="
                  nuevoProductoForm.get('fecha')?.invalid && nuevoProductoForm.get('fecha')?.touched
                "
                class="text-danger small"
              >
                La fecha es requerida
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted small">üë§ CLIENTE</label>
              <input
                type="text"
                class="form-control form-control-sm"
                formControlName="cliente"
                placeholder="Nombre del cliente"
                maxlength="50"
                (focus)="selectAllText($event)"
              />
              <div
                *ngIf="
                  nuevoProductoForm.get('cliente')?.invalid &&
                  nuevoProductoForm.get('cliente')?.touched
                "
                class="text-danger small"
              >
                El cliente es requerido (m√≠n. 2 caracteres)
              </div>
            </div>
          </div>

          <!-- Segunda fila: Factura y Producto -->
          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label text-muted small">üßæ FACTURA</label>
              <input
                type="text"
                class="form-control form-control-sm"
                formControlName="factura"
                placeholder="N√∫mero de factura"
                maxlength="20"
                (focus)="selectAllText($event)"
              />
              <div
                *ngIf="
                  nuevoProductoForm.get('factura')?.invalid &&
                  nuevoProductoForm.get('factura')?.touched
                "
                class="text-danger small"
              >
                La factura es requerida
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted small">üçû PRODUCTO</label>
              <input
                type="text"
                class="form-control form-control-sm"
                formControlName="producto"
                placeholder="Nombre del producto"
                maxlength="100"
                (focus)="selectAllText($event)"
              />
              <div
                *ngIf="
                  nuevoProductoForm.get('producto')?.invalid &&
                  nuevoProductoForm.get('producto')?.touched
                "
                class="text-danger small"
              >
                El producto es requerido
              </div>
            </div>
          </div>

          <!-- Tercera fila: Unidades -->
          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label text-muted small">üì¶ UNIDADES VENDIDAS</label>
              <input
                type="tel"
                inputmode="numeric"
                pattern="[0-9]*"
                class="form-control form-control-sm"
                formControlName="unidadesVendidas"
                placeholder="0"
                min="0"
                maxlength="10"
                (focus)="selectAllText($event)"
                (click)="selectAllText($event)"
                (input)="validateNumericInput($event)"
              />
              <div
                *ngIf="
                  nuevoProductoForm.get('unidadesVendidas')?.invalid &&
                  nuevoProductoForm.get('unidadesVendidas')?.touched
                "
                class="text-danger small"
              >
                Las unidades vendidas son requeridas
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted small">üéÅ UNIDADES PROMOCIONES</label>
              <input
                type="tel"
                inputmode="numeric"
                pattern="[0-9]*"
                class="form-control form-control-sm"
                formControlName="unidadesPromociones"
                placeholder="0"
                min="0"
                maxlength="10"
                (focus)="selectAllText($event)"
                (click)="selectAllText($event)"
                (input)="validateNumericInput($event)"
              />
              <div
                *ngIf="
                  nuevoProductoForm.get('unidadesPromociones')?.invalid &&
                  nuevoProductoForm.get('unidadesPromociones')?.touched
                "
                class="text-danger small"
              >
                Las unidades de promociones son requeridas
              </div>
            </div>
          </div>

          <!-- Cuarta fila: Valor -->
          <div class="row g-2 mb-3">
           <!-- Costo promocional con manejo UNIVERSAL -->
<div class="col-md-6">
  <label class="form-label text-muted small">üí∞ COSTO PROMOCIONAL</label>
  <input
    type="tel"
    inputmode="decimal"
    pattern="[0-9]*\.?[0-9]*"
    class="form-control form-control-sm"
    formControlName="valor"
    placeholder="0.00"
    min="0"
    maxlength="15"
    (focus)="selectAllText($event)"
    (click)="selectAllText($event)"
    (keydown)="onUniversalKeyDown($event)"
    (input)="universalCommaToPoint($event)"
    (keyup)="universalCommaToPoint($event)"
    (paste)="onPasteHandler($event)"
    (change)="universalCommaToPoint($event)"
    (blur)="universalCommaToPoint($event)"
  />
  <div
    *ngIf="nuevoProductoForm.get('valor')?.invalid && nuevoProductoForm.get('valor')?.touched"
    class="text-danger small"
  >
    El costo promocional es requerido
  </div>
</div>
            <div class="col-md-6">
              <label class="form-label text-muted small">üßÆ TOTAL CALCULADO</label>
              <div class="alert alert-info py-2 mb-0">
                <strong>$ {{ totalGeneral.toFixed(2) }}</strong>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            ‚ùå Cancelar
          </button>
          <button type="submit" class="btn btn-success" [disabled]="nuevoProductoForm.invalid">
            ‚úÖ Agregar Registro
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
